# =============================================================================
# AWS Deployment Workflow
# =============================================================================
#
# トリガー:
#   - 手動実行（workflow_dispatch）
#
# 必要なシークレット:
#   - AWS_ACCESS_KEY_ID: AWSアクセスキー
#   - AWS_SECRET_ACCESS_KEY: AWSシークレットキー
#
# 必要な変数:
#   - AWS_REGION: AWSリージョン
#   - AWS_ECR_REGISTRY: ECRレジストリURL
#   - AWS_LAMBDA_FUNCTION: Lambda関数名
#
# =============================================================================

name: Deploy to AWS

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'prod'
        type: choice
        options:
          - dev
          - staging
          - prod
      client:
        description: 'Client name (terraform/clients/<client>)'
        required: true
        type: string
      deploy_infra:
        description: 'Deploy infrastructure (Terraform)'
        required: true
        default: false
        type: boolean
      deploy_app:
        description: 'Deploy application code'
        required: true
        default: true
        type: boolean

env:
  TERRAFORM_VERSION: '1.6.0'
  DOCKER_IMAGE_NAME: ic-test-ai-agent

jobs:
  # ---------------------------------------------------------------------------
  # インフラストラクチャデプロイ（Terraform）
  # ---------------------------------------------------------------------------
  terraform:
    name: Terraform Apply
    runs-on: ubuntu-latest
    if: github.event.inputs.deploy_infra == 'true'
    environment: ${{ github.event.inputs.environment }}

    defaults:
      run:
        working-directory: terraform/clients/${{ github.event.inputs.client }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Terraform Init
        run: terraform init

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        run: terraform plan -out=tfplan

      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan

      - name: Output Results
        run: terraform output -json > terraform-outputs.json

      - name: Upload Terraform Outputs
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs
          path: terraform/clients/${{ github.event.inputs.client }}/terraform-outputs.json

  # ---------------------------------------------------------------------------
  # アプリケーションデプロイ（Lambda）
  # ---------------------------------------------------------------------------
  deploy-app:
    name: Deploy Application
    runs-on: ubuntu-latest
    if: github.event.inputs.deploy_app == 'true'
    needs: [terraform]
    if: always() && (needs.terraform.result == 'success' || needs.terraform.result == 'skipped')
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Install dependencies
        run: |
          pip install -r platforms/aws/requirements.txt -t platforms/aws/package/

      - name: Copy source code
        run: |
          cp -r src platforms/aws/package/
          cp platforms/aws/lambda_handler.py platforms/aws/package/

      - name: Create deployment package
        run: |
          cd platforms/aws/package
          zip -r ../deployment.zip .

      - name: Deploy to Lambda
        run: |
          aws lambda update-function-code \
            --function-name ${{ vars.AWS_LAMBDA_FUNCTION }} \
            --zip-file fileb://platforms/aws/deployment.zip

      - name: Wait for update
        run: |
          aws lambda wait function-updated \
            --function-name ${{ vars.AWS_LAMBDA_FUNCTION }}

  # ---------------------------------------------------------------------------
  # デプロイ検証
  # ---------------------------------------------------------------------------
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy-app
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Test Lambda function
        run: |
          # Lambda関数を直接呼び出してテスト
          aws lambda invoke \
            --function-name ${{ vars.AWS_LAMBDA_FUNCTION }} \
            --payload '{"httpMethod": "GET", "path": "/health"}' \
            --cli-binary-format raw-in-base64-out \
            response.json

          cat response.json

          # ステータスコード確認
          STATUS=$(cat response.json | jq -r '.statusCode')
          if [ "$STATUS" != "200" ]; then
            echo "Health check failed with status: $STATUS"
            exit 1
          fi

          echo "Health check passed!"
