name: Deploy to Azure

on:
  push:
    branches: [main]
    paths:
      - 'platforms/azure/**'
      - 'src/**'
      - 'infrastructure/azure/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        default: 'staging'
        type: choice
        options: [staging, production]

env:
  PYTHON_VERSION: '3.11'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: |
          pip install -r requirements.txt -r requirements-dev.txt
          pytest tests/ -k "not e2e and not integration" --cov=src

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: python scripts/audit_security.py

  deploy:
    runs-on: ubuntu-latest
    needs: [test, security]
    environment: ${{ github.event.inputs.environment || 'staging' }}
    outputs:
      apim-endpoint: ${{ steps.apim-info.outputs.apim-endpoint }}
      apim-subscription-key: ${{ steps.apim-info.outputs.apim-subscription-key }}
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false

      - name: Deploy Infrastructure
        working-directory: ./infrastructure/azure/terraform
        run: |
          terraform init
          terraform plan -out=tfplan \
            -var="resource_group_name=${{ secrets.AZURE_RESOURCE_GROUP }}"
          terraform apply -auto-approve tfplan

      # Terraformデプロイ出力からAPIMエンドポイントとサブスクリプションキーを自動取得
      # Terraformデプロイ出力からリソース名・APIM情報を自動取得
      - name: Get deployment outputs
        id: apim-info
        working-directory: ./infrastructure/azure/terraform
        run: |
          APIM_NAME=$(terraform output -raw apim_name)
          GATEWAY_URL=$(terraform output -raw apim_gateway_url)
          FUNC_APP_NAME=$(terraform output -raw function_app_name)
          RG_NAME="${{ secrets.AZURE_RESOURCE_GROUP }}"

          # Function App名
          echo "function-app-name=${FUNC_APP_NAME}" >> $GITHUB_OUTPUT

          # APIMエンドポイント（API pathは /api）
          APIM_ENDPOINT="${GATEWAY_URL}/api"
          echo "apim-endpoint=${APIM_ENDPOINT}" >> $GITHUB_OUTPUT

          # サブスクリプションキーをAzure REST APIで取得
          SUB_ID=$(az account show --query id -o tsv)
          KEY=$(az rest --method post \
            --url "https://management.azure.com/subscriptions/${SUB_ID}/resourceGroups/${RG_NAME}/providers/Microsoft.ApiManagement/service/${APIM_NAME}/subscriptions/ic-test-ai-subscription/listSecrets?api-version=2023-05-01-preview" \
            --query primaryKey -o tsv)

          echo "::add-mask::${KEY}"
          echo "apim-subscription-key=${KEY}" >> $GITHUB_OUTPUT

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # デプロイパッケージ作成: platforms/azure/ + 共有src/
      - name: Prepare deployment package
        run: |
          mkdir -p deploy-package
          cp platforms/azure/function_app.py deploy-package/
          cp platforms/azure/host.json deploy-package/
          cp platforms/azure/requirements.txt deploy-package/
          cp platforms/azure/.funcignore deploy-package/ 2>/dev/null || true
          cp -r src deploy-package/src
          cd deploy-package
          pip install -r requirements.txt -t .python_packages/lib/site-packages

      - uses: Azure/functions-action@v1
        with:
          app-name: ${{ steps.apim-info.outputs.function-app-name }}
          package: ./deploy-package

  validate:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Validate
        env:
          AZURE_APIM_ENDPOINT: ${{ needs.deploy.outputs.apim-endpoint }}
          AZURE_APIM_SUBSCRIPTION_KEY: ${{ needs.deploy.outputs.apim-subscription-key }}
        run: |
          pip install requests
          python scripts/validate_deployment.py --platform azure
