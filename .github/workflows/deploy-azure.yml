name: Deploy to Azure

on:
  push:
    branches: [main]
    paths:
      - 'Dockerfile'
      - 'src/**'
      - 'platforms/local/**'
      - 'infrastructure/azure/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        default: 'staging'
        type: choice
        options: [staging, production]

concurrency:
  group: deploy-azure
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'
  DOCKER_IMAGE_NAME: ic-test-ai-agent

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: |
          pip install -r requirements.txt -r requirements-dev.txt
          pytest tests/ -k "not e2e and not integration" --cov=src

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: python scripts/audit_security.py

  deploy:
    runs-on: ubuntu-latest
    needs: [test, security]
    environment: ${{ github.event.inputs.environment || 'staging' }}
    steps:
      - uses: actions/checkout@v6

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false

      - name: Set Terraform auth env vars
        run: |
          CREDS='${{ secrets.AZURE_CREDENTIALS }}'
          echo "ARM_CLIENT_ID=$(echo $CREDS | jq -r .clientId)" >> $GITHUB_ENV
          echo "ARM_CLIENT_SECRET=$(echo $CREDS | jq -r .clientSecret)" >> $GITHUB_ENV
          echo "ARM_TENANT_ID=$(echo $CREDS | jq -r .tenantId)" >> $GITHUB_ENV
          echo "ARM_SUBSCRIPTION_ID=$(echo $CREDS | jq -r .subscriptionId)" >> $GITHUB_ENV

      - name: Clean orphaned resources
        run: |
          RG_NAME="${{ secrets.AZURE_RESOURCE_GROUP }}"
          SUFFIX=$(echo -n "$RG_NAME" | md5sum | cut -c1-13)
          az containerapp delete --name "ca-ic-test-ai-prod-$SUFFIX" \
            --resource-group "$RG_NAME" --yes 2>/dev/null || true

      - name: Deploy Infrastructure
        working-directory: ./infrastructure/azure/terraform
        run: |
          terraform init
          terraform plan -out=tfplan \
            -var="resource_group_name=${{ secrets.AZURE_RESOURCE_GROUP }}"
          terraform apply -auto-approve tfplan

      # Terraformデプロイ出力からリソース名・APIM情報を自動取得
      - name: Get deployment outputs
        id: apim-info
        working-directory: ./infrastructure/azure/terraform
        run: |
          APIM_NAME=$(terraform output -raw apim_name)
          GATEWAY_URL=$(terraform output -raw apim_gateway_url)
          ACR_NAME=$(terraform output -raw acr_name)
          CONTAINER_APP_NAME=$(terraform output -raw container_app_name)
          RG_NAME="${{ secrets.AZURE_RESOURCE_GROUP }}"

          # ACR・Container App名
          echo "acr-name=${ACR_NAME}" >> $GITHUB_OUTPUT
          echo "container-app-name=${CONTAINER_APP_NAME}" >> $GITHUB_OUTPUT

          # APIMエンドポイント（API pathは /api）
          APIM_ENDPOINT="${GATEWAY_URL}/api"
          echo "apim-endpoint=${APIM_ENDPOINT}" >> $GITHUB_OUTPUT

          # サブスクリプションキーをAzure REST APIで取得
          SUB_ID=$(az account show --query id -o tsv)
          KEY=$(az rest --method post \
            --url "https://management.azure.com/subscriptions/${SUB_ID}/resourceGroups/${RG_NAME}/providers/Microsoft.ApiManagement/service/${APIM_NAME}/subscriptions/ic-test-ai-subscription/listSecrets?api-version=2023-05-01-preview" \
            --query primaryKey -o tsv)

          # 検証用の環境変数を設定（マスク済み値はジョブ間出力で伝播されないため同一ジョブ内で使用）
          echo "::add-mask::${KEY}"
          echo "AZURE_APIM_SUBSCRIPTION_KEY=${KEY}" >> $GITHUB_ENV
          echo "AZURE_APIM_ENDPOINT=${APIM_ENDPOINT}" >> $GITHUB_ENV

          # 監視・シークレット管理の検証用
          KEY_VAULT_NAME=$(terraform output -raw key_vault_name)
          APP_INSIGHTS_CS=$(terraform output -raw app_insights_connection_string)
          echo "::add-mask::${APP_INSIGHTS_CS}"
          echo "KEY_VAULT_NAME=${KEY_VAULT_NAME}" >> $GITHUB_ENV
          echo "APPLICATIONINSIGHTS_CONNECTION_STRING=${APP_INSIGHTS_CS}" >> $GITHUB_ENV

      # Dockerイメージをビルド・ACRにプッシュ
      - name: Login to ACR
        run: az acr login --name ${{ steps.apim-info.outputs.acr-name }}

      - name: Build and Push Docker Image
        run: |
          ACR_SERVER=${{ steps.apim-info.outputs.acr-name }}.azurecr.io
          IMAGE_TAG=${{ github.sha }}
          docker build -t ${ACR_SERVER}/${{ env.DOCKER_IMAGE_NAME }}:${IMAGE_TAG} .
          docker build -t ${ACR_SERVER}/${{ env.DOCKER_IMAGE_NAME }}:latest .
          docker push ${ACR_SERVER}/${{ env.DOCKER_IMAGE_NAME }}:${IMAGE_TAG}
          docker push ${ACR_SERVER}/${{ env.DOCKER_IMAGE_NAME }}:latest

      # Container Appのイメージを更新
      - name: Deploy to Container Apps
        run: |
          ACR_SERVER=${{ steps.apim-info.outputs.acr-name }}.azurecr.io
          az containerapp update \
            --name ${{ steps.apim-info.outputs.container-app-name }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --image ${ACR_SERVER}/${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}

      # デプロイ後の検証（同一ジョブ内でシークレットを環境変数として参照）
      - name: Setup Python for validation
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Validate deployment
        run: |
          pip install requests
          python scripts/validate_deployment.py --platform azure
