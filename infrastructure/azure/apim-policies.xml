<?xml version="1.0" encoding="UTF-8"?>
<!--
================================================================================
apim-policies.xml - Azure API Management ポリシー定義
================================================================================

【概要】
内部統制テスト評価AIシステムのAzure APIM用ポリシー設定ファイルです。
以下の機能を提供します：
- 相関ID管理（X-Correlation-IDヘッダー）
- API Key認証（Subscription Key）
- レート制限（IPアドレスベース）
- CORSサポート
- Application Insightsへの構造化ログ記録
- バックエンド（Azure Functions）への転送

【適用方法】
1. Azure Portal → API Management → APIs → 対象API
2. "Design" タブ → "All operations" → "Inbound processing"
3. Code editor で本ファイルの内容を貼り付け

【相関IDフロー】
VBA/PowerShell → APIM (検証・ログ) → Azure Functions (処理・ログ)
     ↓                 ↓                      ↓
SessionID生成    X-Correlation-ID     全ログに相関ID含む
                 ヘッダー設定・記録

【設定値の調整】
- rate-limit-by-key: 100 calls/60秒（必要に応じて調整）
- backend-service: Function AppのベースURL

================================================================================
-->
<policies>
    <!-- =================================================================== -->
    <!-- インバウンド処理（リクエスト受信時）                                    -->
    <!-- =================================================================== -->
    <inbound>
        <!-- 1. ベースURL設定 -->
        <base />

        <!-- 2. CORS設定（クロスオリジンリクエスト対応） -->
        <cors allow-credentials="false">
            <allowed-origins>
                <origin>*</origin>
            </allowed-origins>
            <allowed-methods>
                <method>GET</method>
                <method>POST</method>
                <method>OPTIONS</method>
            </allowed-methods>
            <allowed-headers>
                <header>*</header>
            </allowed-headers>
            <expose-headers>
                <header>X-Correlation-ID</header>
            </expose-headers>
        </cors>

        <!-- 3. 相関ID設定（リクエストヘッダーから取得、なければGUID生成） -->
        <set-variable name="correlation-id"
                      value="@{
                          string correlationId = context.Request.Headers.GetValueOrDefault(&quot;X-Correlation-ID&quot;, &quot;&quot;);
                          if (string.IsNullOrEmpty(correlationId))
                          {
                              correlationId = Guid.NewGuid().ToString();
                          }
                          return correlationId;
                      }" />

        <!-- 4. 相関IDをリクエストヘッダーに設定（バックエンドに転送） -->
        <set-header name="X-Correlation-ID" exists-action="override">
            <value>@((string)context.Variables["correlation-id"])</value>
        </set-header>

        <!-- 5. API Key認証（Subscription Key検証） -->
        <check-header name="Ocp-Apim-Subscription-Key"
                     failed-check-httpcode="401"
                     failed-check-error-message="Unauthorized: Subscription Key is required"
                     ignore-case="false" />

        <!-- 6. レート制限（IPアドレスベース：100呼び出し/60秒） -->
        <rate-limit-by-key calls="100"
                          renewal-period="60"
                          counter-key="@(context.Request.IpAddress)"
                          increment-condition="@(context.Response.StatusCode >= 200 &amp;&amp; context.Response.StatusCode &lt; 300)" />

        <!-- 7. リクエスト情報をApplication Insightsにログ記録 -->
        <trace source="apim-inbound" severity="information">
            <message>@{
                return new JObject(
                    new JProperty("timestamp", DateTime.UtcNow.ToString("o")),
                    new JProperty("correlation_id", (string)context.Variables["correlation-id"]),
                    new JProperty("event", "request_received"),
                    new JProperty("method", context.Request.Method),
                    new JProperty("url", context.Request.Url.ToString()),
                    new JProperty("client_ip", context.Request.IpAddress),
                    new JProperty("user_agent", context.Request.Headers.GetValueOrDefault("User-Agent", "unknown")),
                    new JProperty("operation_name", context.Operation.Name),
                    new JProperty("api_id", context.Api.Id)
                ).ToString();
            }</message>
            <metadata name="correlation_id" value="@((string)context.Variables["correlation-id"])" />
        </trace>

        <!-- 8. リクエストサイズ制限（10MB） -->
        <set-header name="Content-Length" exists-action="skip">
            <value>@(context.Request.Body.As&lt;string&gt;(preserveContent: true).Length.ToString())</value>
        </set-header>
        <choose>
            <when condition="@(context.Request.Body.As&lt;string&gt;(preserveContent: true).Length &gt; 10485760)">
                <return-response>
                    <set-status code="413" reason="Payload Too Large" />
                    <set-header name="Content-Type" exists-action="override">
                        <value>application/json</value>
                    </set-header>
                    <set-header name="X-Correlation-ID" exists-action="override">
                        <value>@((string)context.Variables["correlation-id"])</value>
                    </set-header>
                    <set-body>@{
                        return new JObject(
                            new JProperty("error", true),
                            new JProperty("message", "Request body too large (max 10MB)"),
                            new JProperty("correlation_id", (string)context.Variables["correlation-id"])
                        ).ToString();
                    }</set-body>
                </return-response>
            </when>
        </choose>

        <!-- 9. バックエンド（Azure Functions）へのルーティング -->
        <!-- Note: backend-serviceは"Backend"セクションで設定されたFunction App URLを参照 -->
        <set-backend-service base-url="{{backend-function-app-url}}" />

    </inbound>

    <!-- =================================================================== -->
    <!-- バックエンド処理                                                      -->
    <!-- =================================================================== -->
    <backend>
        <base />
    </backend>

    <!-- =================================================================== -->
    <!-- アウトバウンド処理（レスポンス送信時）                                 -->
    <!-- =================================================================== -->
    <outbound>
        <base />

        <!-- 1. 相関IDをレスポンスヘッダーに追加 -->
        <set-header name="X-Correlation-ID" exists-action="override">
            <value>@((string)context.Variables["correlation-id"])</value>
        </set-header>

        <!-- 2. レスポンス情報をApplication Insightsにログ記録 -->
        <trace source="apim-outbound" severity="information">
            <message>@{
                return new JObject(
                    new JProperty("timestamp", DateTime.UtcNow.ToString("o")),
                    new JProperty("correlation_id", (string)context.Variables["correlation-id"]),
                    new JProperty("event", "response_sent"),
                    new JProperty("status_code", context.Response.StatusCode),
                    new JProperty("elapsed_ms", context.Elapsed.TotalMilliseconds),
                    new JProperty("operation_name", context.Operation.Name),
                    new JProperty("backend_response_time_ms", context.Variables.GetValueOrDefault&lt;TimeSpan&gt;("backend-time", TimeSpan.Zero).TotalMilliseconds)
                ).ToString();
            }</message>
            <metadata name="correlation_id" value="@((string)context.Variables["correlation-id"])" />
            <metadata name="status_code" value="@(context.Response.StatusCode.ToString())" />
        </trace>

        <!-- 3. セキュリティヘッダー追加 -->
        <set-header name="X-Content-Type-Options" exists-action="override">
            <value>nosniff</value>
        </set-header>
        <set-header name="X-Frame-Options" exists-action="override">
            <value>DENY</value>
        </set-header>
        <set-header name="Strict-Transport-Security" exists-action="override">
            <value>max-age=31536000; includeSubDomains</value>
        </set-header>

    </outbound>

    <!-- =================================================================== -->
    <!-- エラー処理                                                           -->
    <!-- =================================================================== -->
    <on-error>
        <base />

        <!-- 1. 相関IDをエラーレスポンスに含める -->
        <set-header name="X-Correlation-ID" exists-action="override">
            <value>@((string)context.Variables.GetValueOrDefault("correlation-id", Guid.NewGuid().ToString()))</value>
        </set-header>

        <!-- 2. エラー情報をApplication Insightsにログ記録 -->
        <trace source="apim-error" severity="error">
            <message>@{
                return new JObject(
                    new JProperty("timestamp", DateTime.UtcNow.ToString("o")),
                    new JProperty("correlation_id", (string)context.Variables.GetValueOrDefault("correlation-id", Guid.NewGuid().ToString())),
                    new JProperty("event", "error_occurred"),
                    new JProperty("error_source", context.LastError.Source),
                    new JProperty("error_reason", context.LastError.Reason),
                    new JProperty("error_message", context.LastError.Message),
                    new JProperty("error_scope", context.LastError.Scope),
                    new JProperty("error_section", context.LastError.Section),
                    new JProperty("operation_name", context.Operation.Name),
                    new JProperty("client_ip", context.Request.IpAddress)
                ).ToString();
            }</message>
            <metadata name="correlation_id" value="@((string)context.Variables.GetValueOrDefault("correlation-id", Guid.NewGuid().ToString()))" />
            <metadata name="error_source" value="@(context.LastError.Source)" />
        </trace>

        <!-- 3. ユーザーフレンドリーなエラーレスポンスを返す -->
        <return-response>
            <set-status code="@(context.Response.StatusCode)" reason="@(context.Response.StatusReason)" />
            <set-header name="Content-Type" exists-action="override">
                <value>application/json; charset=utf-8</value>
            </set-header>
            <set-body>@{
                var correlationId = (string)context.Variables.GetValueOrDefault("correlation-id", Guid.NewGuid().ToString());
                var statusCode = context.Response.StatusCode;

                // ステータスコードに応じたユーザー向けメッセージ
                string userMessage = "An error occurred while processing your request.";
                switch (statusCode)
                {
                    case 401:
                        userMessage = "認証に失敗しました。API Keyを確認してください。";
                        break;
                    case 403:
                        userMessage = "このリソースへのアクセス権限がありません。";
                        break;
                    case 404:
                        userMessage = "指定されたエンドポイントが見つかりません。";
                        break;
                    case 413:
                        userMessage = "リクエストサイズが大きすぎます（最大10MB）。";
                        break;
                    case 429:
                        userMessage = "リクエスト制限を超えました。しばらくしてから再試行してください。";
                        break;
                    case 500:
                    case 502:
                    case 503:
                    case 504:
                        userMessage = "サーバーエラーが発生しました。しばらくしてから再試行してください。";
                        break;
                }

                return new JObject(
                    new JProperty("error", true),
                    new JProperty("message", userMessage),
                    new JProperty("correlation_id", correlationId),
                    new JProperty("timestamp", DateTime.UtcNow.ToString("o")),
                    new JProperty("status_code", statusCode)
                ).ToString();
            }</set-body>
        </return-response>

    </on-error>

</policies>
